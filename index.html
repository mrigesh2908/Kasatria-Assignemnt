<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>3D-ish Periodic Table â€” CSS 3D</title>

<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
:root{
  --tile-w:160px;
  --tile-h:200px;
}

html,body{
  height:100%;
  margin:0;
  background:#0d0d0d;
  color:#eee;
  font-family:Inter,Arial,Helvetica,sans-serif;
  overflow:hidden;
}

#ui{
  position:fixed;
  left:12px;
  top:12px;
  z-index:50;
  display:flex;
  gap:8px;
  align-items:center;
  background:rgba(0,0,0,0.6);
  padding:8px 12px;
  border-radius:10px;
  backdrop-filter:blur(6px);
}
button,select{
  font-size:14px;
  padding:6px 10px;
  border-radius:6px;
  border:0;
  background:#222;
  color:#fff;
  cursor:pointer;
}

#container{
  width:100vw;
  height:100vh;
  perspective:1600px;
  position:relative;
}

.stage{
  width:100%;
  height:100%;
  transform-style:preserve-3d;
  position:absolute;
  left:0;top:0;
}

.tile{
  width:var(--tile-w);
  height:var(--tile-h);
  position:absolute;
  left:50%; top:50%;
  transform-style:preserve-3d;
  backface-visibility:visible;
  border-radius:12px;
  overflow:hidden;
  box-shadow:0 10px 40px rgba(0,0,0,0.55);
  padding:10px;
  display:flex;
  flex-direction:column;
  align-items:center;
  font-size:13px;
  opacity:0;
  transition:transform 1s cubic-bezier(.2,.7,.2,1), opacity .8s;
}

.tile img{
  width:100%;
  height:90px;
  object-fit:cover;
  border-radius:6px;
  margin-bottom:6px;
}

.name{
  font-weight:700;
  margin-bottom:4px;
  text-align:center;
}

.meta{
  font-size:12px;
  text-align:center;
}

@media (max-width:900px){
  :root{
    --tile-w:130px;
    --tile-h:170px;
  }
}
</style>

<body>
<div id="ui">

  <!-- YOU MUST REPLACE "YOUR_GOOGLE_CLIENT_ID" AFTER PASTING -->
  <div id="g_id_onload"
    data-client_id="699948358244-7q1jjb5i36toidhhivnngpb77so71t1j.apps.googleusercontent.com"
    data-context="signin"
    data-ux_mode="popup"
    data-callback="handleCredentialResponse">
  </div>

  <div class="g_id_signin" data-type="standard"></div>

  <button id="loadBtn" disabled>Load Data</button>

  <select id="layout">
    <option value="table">Table</option>
    <option value="sphere">Sphere</option>
    <option value="doubleHelix">Double Helix</option>
    <option value="grid">Grid</option>
    <option value="tetrahedron">Tetrahedron (4-Face Pyramid)</option>
  </select>

  <button id="apply">Apply</button>
</div>

<div id="container">
  <div id="stage" class="stage"></div>
</div>

<script>
/* ============================================
      GOOGLE LOGIN FIX
============================================ */
window.handleCredentialResponse = function(response) {
  const payload = JSON.parse(atob(response.credential.split('.')[1]));
  alert(`Hello ${payload.name}!`);
  document.getElementById("loadBtn").disabled = false;
};

// Initialize Google Sign-In
window.onload = () => {
  google.accounts.id.initialize({
    client_id: "699948358244-7q1jjb5i36toidhhivnngpb77so71t1j.apps.googleusercontent.com",
    callback: handleCredentialResponse
  });

  google.accounts.id.renderButton(
    document.querySelector(".g_id_signin"),
    { theme: "outline", size: "medium" }
  );

  google.accounts.id.prompt(); // optional, auto prompt sign-in
};

/* ============================================
      GLOBALS
============================================ */
const stage = document.getElementById("stage");
let items = [];

let rotX = 0;
let rotY = 0;

/* ============================================
      UNIVERSAL AUTO-FIT SYSTEM
============================================ */
function fitSceneToScreen() {

  const tiles = [...document.querySelectorAll(".tile")];

  if (!tiles.length) return;

  let minX = Infinity, maxX = -Infinity;
  let minY = Infinity, maxY = -Infinity;

  tiles.forEach(tile => {
    const m = new DOMMatrixReadOnly(getComputedStyle(tile).transform);
    minX = Math.min(minX, m.m41);
    maxX = Math.max(maxX, m.m41);
    minY = Math.min(minY, m.m42);
    maxY = Math.max(maxY, m.m42);
  });

  const width = maxX - minX + 300;
  const height = maxY - minY + 300;

  const scaleX = window.innerWidth / width;
  const scaleY = window.innerHeight / height;

  const scale = Math.min(scaleX, scaleY);

  stage.dataset.baseScale = scale;
  applyStageTransform();
}

/* ============================================
      APPLY FINAL STAGE TRANSFORM (ROT + SCALE)
============================================ */
function applyStageTransform() {
  const scale = Number(stage.dataset.baseScale || 1);
  stage.style.transform =
    `scale(${scale}) rotateX(${rotX}deg) rotateY(${rotY}deg)`;
}

/* ============================================
      CSV PARSER (unchanged)
============================================ */
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSpokab2VctDgtMFhlHgI9x6rPrE3gkBN7RsvkmsBeUYUrq8t25y4sVUyJ-XTnfC6q9qznY2mJPHOLY/pub?gid=1348231379&single=true&output=csv";

function parseCSV(text){
  const rows = [];
  let cur = "", inQuote = false;
  const lines = [];

  for(const ch of text){
    if(ch === '"'){ inQuote = !inQuote; cur+=ch; continue; }
    if(ch === "\n" && !inQuote){ lines.push(cur); cur=""; continue; }
    if(ch !== "\r") cur += ch;
  }
  if(cur) lines.push(cur);

  for(const line of lines){
    const fields=[]; let buf="", q=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c=='"' && line[i+1]=='"'){ buf+='"'; i++; continue; }
      if(c=='"'){ q=!q; continue; }
      if(c==',' && !q){ fields.push(buf); buf=""; continue; }
      buf+=c;
    }
    fields.push(buf);
    rows.push(fields.map(s=>s.trim()));
  }

  const headers = rows.shift();
  return rows.map(r=>{
    const obj={};
    for(let i=0;i<headers.length;i++) obj[headers[i]]=r[i]||"";
    return obj;
  });
}

function parseNetWorth(str){
  if(!str) return 0;
  const clean = str.replace(/[\$,]/g,"").trim();
  if(/k$/i.test(clean)) return parseFloat(clean)*1000;
  if(/m$/i.test(clean)) return parseFloat(clean)*1_000_000;
  return parseFloat(clean) || 0;
}

function colorForNet(n){
  if(n<100000) return "#ff6b6b";
  if(n<=200000) return "#ffb84d";
  return "#66cc66";
}

/* ============================================
      LOAD + BUILD TILES
============================================ */
async function loadData(){
  try{
    const res = await fetch(CSV_URL);
    const text = await res.text();
    const data = parseCSV(text);

    items = data.map(d => ({
      Name: d["Name"] || d["Full Name"] || "",
      Photo: d["Photo"] || "",
      Age: d["Age"] || "",
      Country: d["Country"] || "",
      Interest: d["Interest"] || "",
      NetWorthRaw: d["Net Worth"] || ""
    }));

    createTiles();
    alert("Loaded "+items.length+" rows");
  }catch(err){
    alert("Error loading CSV");
  }
}

function createTiles(){
  stage.innerHTML = "";
  items.forEach((it,i)=>{
    const el = document.createElement("div");
    el.className="tile";

    const img = document.createElement("img");
    img.src = it.Photo;
    img.onerror = ()=> img.src="https://via.placeholder.com/320x180?text=No+Image";

    const nm = document.createElement("div");
    nm.className="name";
    nm.textContent = it.Name;

    const meta = document.createElement("div");
    meta.className="meta";
    meta.innerHTML =
      `Age: ${it.Age}<br>Country: ${it.Country}<br>${it.Interest}<br>${it.NetWorthRaw}`;

    el.appendChild(img);
    el.appendChild(nm);
    el.appendChild(meta);

    el.style.background = colorForNet(parseNetWorth(it.NetWorthRaw));

    stage.appendChild(el);
    items[i].el = el;

    setTimeout(()=> el.style.opacity=1, 60 + (i%20)*15);
  });
}

/* ============================================
      TRANSFORM HELPER
============================================ */
function transform(el,x,y,z,rx=0,ry=0){
  el.style.transform =
    `translate3d(${x}px,${y}px,${z}px)
     translate(-50%,-50%)
     rotateX(${rx}deg)
     rotateY(${ry}deg)`;
}

/* ============================================
      LAYOUT FUNCTIONS
============================================ */
function layoutTable() {
  const cols = 20;
  const rows = Math.ceil(items.length / cols);

  const tileW = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--tile-w'));
  const tileH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--tile-h'));
  const spacingX = tileW * 1.4;
  const spacingY = tileH * 1.4;

  const offsetX = ((cols-1)*spacingX)/2;
  const offsetY = ((rows-1)*spacingY)/2;

  items.forEach((it,i)=>{
    const col = i % cols;
    const row = Math.floor(i / cols);
    const x = col*spacingX - offsetX;
    const y = row*spacingY - offsetY;
    transform(it.el, x, y, 0);
  });

  fitSceneToScreen();
}

function layoutSphere(){
  const N = items.length;
  const R = Math.min(innerWidth,innerHeight)*0.45;

  for(let i=0;i<N;i++){
    const phi = Math.acos(-1 + (2*i)/N);
    const theta = Math.sqrt(N*Math.PI)*phi;
    transform(
      items[i].el,
      R*Math.cos(theta)*Math.sin(phi),
      R*Math.sin(theta)*Math.sin(phi),
      R*Math.cos(phi)
    );
  }

  fitSceneToScreen();
}

function layoutDoubleHelix(){
  const R = 280;
  const spacing = 50;
  const angleStep = 0.3;

  items.forEach((it,i)=>{
    const strand = i % 2;
    const a = i * angleStep;
    const offsetAngle = strand===0 ? 0 : Math.PI;
    const x = Math.cos(a+offsetAngle)*R;
    const z = Math.sin(a+offsetAngle)*R;
    const y = i*spacing/2 - items.length*spacing/4;
    transform(it.el, x, y, z, 0, (a+offsetAngle)*40);
  });

  fitSceneToScreen();
}

function layoutGrid(){
  const nx=5, ny=4, nz=10;
  const sep=320;
  let i=0;

  for(let x=0;x<nx;x++){
    for(let y=0;y<ny;y++){
      for(let z=0;z<nz;z++){
        if(i>=items.length) break;
        transform(items[i].el,
          x*sep-(nx-1)*sep/2,
          y*sep-(ny-1)*sep/2,
          z*sep-(nz-1)*sep/2
        );
        i++;
      }
    }
  }

  fitSceneToScreen();
}

function layoutTetrahedron() {
  const N = items.length;
  const H = 400;
  const R = 300;

  const vTop = {x:0, y:H/2, z:0};
  const v0 = {x:-R/2, y:-H/2, z:-R/2};
  const v1 = {x:R/2,  y:-H/2, z:-R/2};
  const v2 = {x:0,    y:-H/2, z:R/2};

  const faces = [
    [vTop, v0, v1],
    [vTop, v1, v2],
    [vTop, v2, v0],
    [v0, v1, v2] // base
  ];

  let i = 0;
  const tilesPerFace = Math.ceil(N / 4);

  for (let f = 0; f < faces.length; f++) {
    const [A,B,C] = faces[f];
    const steps = Math.ceil((Math.sqrt(8 * tilesPerFace + 1) - 1)/2); // exact steps to cover tilesPerFace

    for (let row = 0; row < steps; row++) {
      for (let col = 0; col <= row; col++) {
        if (i >= N) break;

        // Barycentric coordinates
        const a = 1 - row/steps;
        const b = (row - col)/steps;
        const c = col/steps;

        const x = a*A.x + b*B.x + c*C.x;
        const y = a*A.y + b*B.y + c*C.y;
        const z = a*A.z + b*B.z + c*C.z;

        transform(items[i].el, x, y, z, 0, 0);
        i++;
      }
    }
  }

  fitSceneToScreen();
}


/* ============================================
      LAYOUT SELECTION
============================================ */
function setLayout(type){
  if(type==="table") layoutTable();
  else if(type==="sphere") layoutSphere();
  else if(type==="doubleHelix") layoutDoubleHelix();
  else if(type==="grid") layoutGrid();
  else if(type==="tetrahedron") layoutTetrahedron();
}

/* ============================================
      ROTATE WITH MOUSE
============================================ */
container.addEventListener("pointerdown", e=>{
  window.isDown = true;
  window.lx = e.clientX;
  window.ly = e.clientY;
});
container.addEventListener("pointerup", ()=> window.isDown=false);

container.addEventListener("pointermove", e=>{
  if(!window.isDown) return;
  const dx = e.clientX - window.lx;
  const dy = e.clientY - window.ly;

  rotY += dx*0.2;
  rotX -= dy*0.2;

  applyStageTransform();

  window.lx = e.clientX;
  window.ly = e.clientY;
});

/* ============================================
      BUTTONS
============================================ */
document.getElementById("loadBtn").onclick = loadData;
document.getElementById("apply").onclick = () => {
  const v = document.getElementById("layout").value;
  if(!items.length){ alert("Load data first"); return; }
  setLayout(v);
};
</script>
</body>
</html>
